bwa index GRCh38_full_plus_hs38d1_analysis_set_minus_alts.fa


/home/nhansen/projects/bwa/bwa-0.7.15/bwa mem GRCh38_full_plus_hs38d1_analysis_set_minus_alts.fa input_sequences.fa  | samtools view -Sb - > input_sequences_unsorted.bam
samtools sort -o input_sequences.bam input_sequences_unsorted.bam
samtools index input_sequences.bam

# Check that there are no unmapped reads in the input BAM because might lead to unknown behaviour:

samtools view -c -f 0x4 /data/projects/phillippy/projects/hackathon/shared/alignments/SevenGenomesPlusGRCh38Alts.bam

samtools view -F 0x4 -F 0x100 -F 0x800 -bo /data/projects/phillippy/projects/hackathon/shared/alignments/SevenGenomesPlusGRCh38Alts.primary.bam /data/projects/phillippy/projects/hackathon/shared/alignments/SevenGenomesPlusGRCh38Alts.bam

[diltheyat@gry-compute50 /data/projects/phillippy/projects/hackathon/Graph_Genomes_CSHL/scripts]:./BAM2AARTI.pl --BAM /data/projects/phillippy/projects/hackathon/shared/alignments/SevenGenomesPlusGRCh38Alts.bam --referenceFasta /data/projects/phillippy/projects/hackathon/shared/reference/GRCh38_full_plus_hs38d1_analysis_set_minus_alts.fa --readsFasta /data/projects/phillippy/projects/hackathon/shared/contigs/AllContigs.fa --outputFile /data/projects/phillippy/projects/hackathon/intermediate_files/AartiInput

# Check that /data/projects/phillippy/projects/hackathon/intermediate_files/AartiInput.sortedWithHeader is NEW and was created correctly!

[diltheyat@gry-compute50 /data/projects/phillippy/projects/hackathon/Graph_Genomes_CSHL/scripts]:./FIND_GLOBAL_ALIGNMENTS.pl --alignmentsFile /data/projects/phillippy/projects/hackathon/intermediate_files/AartiInput.sortedWithHeader --referenceFasta /data/projects/phillippy/projects/hackathon/shared/reference/GRCh38_full_plus_hs38d1_analysis_set_minus_alts.fa --outputFile /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT.bam --outputTruncatedReads /data/projects/phillippy/projects/hackathon/intermediate_files/truncatedReads --outputReadLengths /data/projects/phillippy/projects/hackathon/intermediate_files/postGlobalAlignment_readLengths


[diltheyat@gry-compute50 /data/projects/phillippy/projects/hackathon/Graph_Genomes_CSHL/scripts] ./BAM2MAFFT.pl --BAM /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT.bam --referenceFasta /data/projects/phillippy/projects/hackathon/shared/reference/GRCh38_full_plus_hs38d1_analysis_set_minus_alts.fa --readsFasta /data/projects/phillippy/projects/hackathon/shared/contigs/AllContigs.fa --outputDirectory /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT --inputTruncatedReads /data/projects/phillippy/projects/hackathon/intermediate_files/truncatedReads 

./countExpectedGlobalAlignments.pl --BAM /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT.bam

PATH=$PATH:/data/projects/phillippy/projects/rDNA/mafft/mafft-7.273-with-extensions/install/bin/

./CALLMAFFT.pl --action kickOff --mafftDirectory /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT --qsub 1
./CALLMAFFT.pl --action check --mafftDirectory /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT
./CALLMAFFT.pl --action reprocess --mafftDirectory /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT

####  /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT/_windowsInfo

./globalize_windowbams.pl --fastadir /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT/ --msadir /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT/ --bamheader /data/projects/phillippy/projects/hackathon/Graph_Genomes_CSHL/config/GRCh38.headerfile.txt --contigs /data/projects/phillippy/projects/hackathon/intermediate_files/postGlobalAlignment_readLengths --output /data/projects/phillippy/projects/hackathon/intermediate_files/combined.bam

./checkMAFFT_input_and_output.pl --MAFFTdir /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT/ --contigLengths /data/projects/phillippy/projects/hackathon/intermediate_files/postGlobalAlignment_readLengths --preMAFFTBAM /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT.bam --finalOutputBAM /data/projects/phillippy/projects/hackathon/intermediate_files/combined_sorted.bam

# print SAM output

./globalize_windowbams.pl --fastadir /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT/ --msadir /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT/ --contigs /data/projects/phillippy/projects/hackathon/intermediate_files/postGlobalAlignment_readLengths --output /data/projects/phillippy/projects/hackathon/intermediate_files/combined.sam;\
cat /data/projects/phillippy/projects/hackathon/intermediate_files/combined.sam | /data/projects/phillippy/software/samtools-1.4/samtools view -u -t /data/projects/phillippy/projects/hackathon/Graph_Genomes_CSHL/config/GRCh38.headerfile.txt - >  /data/projects/phillippy/projects/hackathon/intermediate_files/combined.bam;\
/data/projects/phillippy/software/samtools-1.4/samtools sort /data/projects/phillippy/projects/hackathon/intermediate_files/combined.bam > /data/projects/phillippy/projects/hackathon/intermediate_files/combined_sorted.bam;\
/data/projects/phillippy/software/samtools-1.4/samtools index /data/projects/phillippy/projects/hackathon/intermediate_files/combined_sorted.bam;\
./checkMAFFT_input_and_output.pl --MAFFTdir /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT/ --contigLengths /data/projects/phillippy/projects/hackathon/intermediate_files/postGlobalAlignment_readLengths --preMAFFTBAM /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT.bam --finalOutputBAM /data/projects/phillippy/projects/hackathon/intermediate_files/combined_sorted.bam &> output_checkMAFFT4

./validate_BAM_MSA.pl --BAM /data/projects/phillippy/projects/hackathon/intermediate_files/combined_sorted.bam --referenceFasta /data/projects/phillippy/projects/hackathon/shared/reference/GRCh38_full_plus_hs38d1_analysis_set_minus_alts.fa


./BAM2VCF.pl --BAM /data/projects/phillippy/projects/hackathon/intermediate_files/combined_sorted.bam --referenceFasta /data/projects/phillippy/projects/hackathon/shared/reference/GRCh38_full_plus_hs38d1_analysis_set_minus_alts.fa --output VCF/uber_vcf.vcf

# get CRAM, via SAM sort?

/data/projects/phillippy/software/samtools-1.4/samtools view -h -t /data/projects/phillippy/projects/hackathon/Graph_Genomes_CSHL/config/GRCh38.headerfile.txt /data/projects/phillippy/projects/hackathon/intermediate_files/combined.sam > /data/projects/phillippy/projects/hackathon/intermediate_files/combined_with_header.sam

/data/projects/phillippy/software/samtools-develop/samtools sort /data/projects/phillippy/projects/hackathon/intermediate_files/combined_with_header.sam -o /data/projects/phillippy/projects/hackathon/intermediate_files/combined_with_header_sorted.sam

cat /data/projects/phillippy/projects/hackathon/intermediate_files/combined_with_header_sorted.sam | /data/projects/phillippy/software/samtools-1.4/samtools view -C -T /data/projects/phillippy/projects/hackathon/shared/reference/GRCh38_full_plus_hs38d1_analysis_set_minus_alts.fa - >  /data/projects/phillippy/projects/hackathon/intermediate_files/combined.cram


./checkFinalCRAM.pl --MAFFTdir /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT/ --contigLengths /data/projects/phillippy/projects/hackathon/intermediate_files/postGlobalAlignment_readLengths --preMAFFTBAM /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT.bam --finalOutputCRAM /data/projects/phillippy/projects/hackathon/intermediate_files/combined_sorted.cram

	 E.g. what happened to HG003.010683F ?


./checkMAFFT_input_and_output.pl --MAFFTdir /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT/ --contigLengths /data/projects/phillippy/projects/hackathon/intermediate_files/postGlobalAlignment_readLengths --preMAFFTBAM /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT.bam --finalOutputBAM /data/projects/phillippy/projects/hackathon/intermediate_files/combined_sorted.cram


???



./CRAM2VCF.pl --CRAM /data/projects/phillippy/projects/hackathon/intermediate_files/combined.cram --referenceFasta /data/projects/phillippy/projects/hackathon/shared/reference/GRCh38_full_plus_hs38d1_analysis_set_minus_alts.fa --output VCF/uber_vcf.vcf --contigLengths /data/projects/phillippy/projects/hackathon/intermediate_files/postGlobalAlignment_readLengths



####### DONE!!!


# Testing command:

../BAM2VCF/BAM2VCF --input VCF/uber_vcf.vcf.part_chr21 --referenceSequenceID chr21



gg-wrapper-bam2vcf.pl --script BAM2VCF.pl --BAM /data/projects/phillippy/projects/hackathon/intermediate_files/combined.bam --referenceFasta /data/projects/phillippy/projects/hackathon/shared/reference/GRCh38_full_plus_hs38d1_analysis_set_minus_alts.fa --window 100000 --samples /data/projects/phillippy/projects/hackathon/Graph_Genomes_CSHL/examples/list_of_assemblies.txt --outputDirectory /data/projects/phillippy/projects/hackathon/intermediate_files/forVG | parallel -j 8

./gg-wrapper-bam2vcf.pl --script ./BAM2VCF.pl --BAM uber_sorted.bam --referenceFasta /data/projects/phillippy/projects/hackathon/shared/reference/GRCh38_full_plus_hs38d1_analysis_set_minus_alts.fa --window 10000000 --samples /data/projects/phillippy/projects/hackathon/Graph_Genomes_CSHL/examples/list_of_assemblies.txt --outputDirectory /data/projects/phillippy/projects/hackathon/intermediate_files/forVG  | parallel -j 8


	
## Some statistics on alignment numbers:

Step 1: Pre-mafft

wc /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT.bam.sam.unfiltered /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT.bam.sam.unfiltered.filtered
      65146      695957 19090345857 /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT.bam.sam.unfiltered
      65137      695858 18700360463 /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT.bam.sam.unfiltered.filtered

	  
	  .. of which 2581 are header lines:
		grep '^@' /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT.bam.sam.unfiltered
		
	i.e. CIGAR filtering removes 9 alignments, and we should have 62565 reported read lengths and 62556 alignments in the BAM that goes into the MAFFT process
	  
samtools view -c /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT.bam
	62556
	
wc /data/projects/phillippy/projects/hackathon/intermediate_files/postGlobalAlignment_readLengths
  62565  125130 1860078 /data/projects/phillippy/projects/hackathon/intermediate_files/postGlobalAlignment_readLengths
  
Step 2: Post-mafft
  
wc /data/projects/phillippy/projects/hackathon/intermediate_files/combined.sam
      56918      626098 18857093184 /data/projects/phillippy/projects/hackathon/intermediate_files/combined.sam

What happens to the other reads???

./checkMAFFT_input_and_output.pl --MAFFTdir /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT/ --contigLengths /data/projects/phillippy/projects/hackathon/intermediate_files/postGlobalAlignment_readLengths --preMAFFTBAM /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT.bam --finalOutputCRAM /data/projects/phillippy/projects/hackathon/intermediate_files/combined.sam &> output_checkMAFFT5


# double-check whether we get good coverage of putative variants

samtools mpileup --no-BAQ -r chr21 --fasta-ref /data/projects/phillippy/projects/hackathon/shared/reference/GRCh38_full_plus_hs38d1_analysis_set_minus_alts.fa /data/projects/phillippy/projects/hackathon/shared/alignments/SevenGenomesPlusGRCh38Alts.bam > pileup21
samtools mpileup --no-BAQ -r chr21 /data/projects/phillippy/projects/hackathon/shared/alignments/SevenGenomesPlusGRCh38Alts.bam > pileup21



# R code for selecting some random insertions


D <- read.delim("_CRAM2VCF_gaps.txt", header = F, stringsAsFactors = F)
idx_500p <- which(D[[3]] >= 500)
idx_500p_r <- sample(idx_500p, 10)
D[,idx_500p_r]

E.g. take these:

34558 chr21 28891726   4729
51120 chr21 46060140  31837
50742 chr21 45802714 123647
242   chr21  5289128   1247
39875 chr21 34702674    946
39778 chr21 34700642    628
13832 chr21 10424743   2555
39509 chr21 34695843    820
39636 chr21 34697908    520
39788 chr21 34700829    822

