# This step assumes that you have a reference file GRCh38_full_plus_hs38d1_analysis_set_minus_alts.fa (GRCh38 without ALTs)
# and a contigs file input_sequences.fa

bwa index GRCh38_full_plus_hs38d1_analysis_set_minus_alts.fa
bwa mem GRCh38_full_plus_hs38d1_analysis_set_minus_alts.fa input_sequences.fa  | samtools view -Sb - > input_sequences_unsorted.bam
samtools sort -o SevenGenomesPlusGRCh38Alts.bam input_sequences_unsorted.bam
samtools index SevenGenomesPlusGRCh38Alts.bam
unlink input_sequences_unsorted.bam
mv SevenGenomesPlusGRCh38Alts.bam /data/projects/phillippy/projects/hackathon/shared/alignments/SevenGenomesPlusGRCh38Alts.bam

/data/projects/phillippy/projects/hackathon/shared/reference/GRCh38_full_plus_hs38d1_analysis_set_minus_alts.fa

# Check that there are no unmapped reads in the input BAM because this might lead to unknown behaviour:
samtools view -c -f 0x4 /data/projects/phillippy/projects/hackathon/shared/alignments/SevenGenomesPlusGRCh38Alts.bam

# Prepare global alignment
cd /data/projects/phillippy/projects/hackathon/Graph_Genomes_CSHL/scripts
./BAM2AARTI.pl --BAM /data/projects/phillippy/projects/hackathon/shared/alignments/SevenGenomesPlusGRCh38Alts.bam --referenceFasta /data/projects/phillippy/projects/hackathon/shared/reference/GRCh38_full_plus_hs38d1_analysis_set_minus_alts.fa --readsFasta /data/projects/phillippy/projects/hackathon/shared/contigs/AllContigs.fa --outputFile /data/projects/phillippy/projects/hackathon/intermediate_files/AartiInput
./checkBAM_SVs_and_INDELs.pl --BAM /data/projects/phillippy/projects/hackathon/shared/alignments/SevenGenomesPlusGRCh38Alts.bam --referenceFasta /data/projects/phillippy/projects/hackathon/shared/reference/GRCh38_full_plus_hs38d1_analysis_set_minus_alts.fa --readsFasta /data/projects/phillippy/projects/hackathon/shared/contigs/AllContigs.fa


# Check that /data/projects/phillippy/projects/hackathon/intermediate_files/AartiInput.sortedWithHeader is NEW and was created correctly!

[diltheyat@gry-compute50 /data/projects/phillippy/projects/hackathon/Graph_Genomes_CSHL/scripts]:./FIND_GLOBAL_ALIGNMENTS.pl --alignmentsFile /data/projects/phillippy/projects/hackathon/intermediate_files/AartiInput.sortedWithHeader --referenceFasta /data/projects/phillippy/projects/hackathon/shared/reference/GRCh38_full_plus_hs38d1_analysis_set_minus_alts.fa --outputFile /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT.bam --outputTruncatedReads /data/projects/phillippy/projects/hackathon/intermediate_files/truncatedReads --outputReadLengths /data/projects/phillippy/projects/hackathon/intermediate_files/postGlobalAlignment_readLengths


./BAM2MAFFT.pl --BAM /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT.bam --referenceFasta /data/projects/phillippy/projects/hackathon/shared/reference/GRCh38_full_plus_hs38d1_analysis_set_minus_alts.fa --readsFasta /data/projects/phillippy/projects/hackathon/shared/contigs/AllContigs.fa --outputDirectory /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT --inputTruncatedReads /data/projects/phillippy/projects/hackathon/intermediate_files/truncatedReads 

./countExpectedGlobalAlignments.pl --BAM /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT.bam

./CALLMAFFT.pl --action kickOff --mafftDirectory /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT --qsub 1
./CALLMAFFT.pl --action check --mafftDirectory /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT
./CALLMAFFT.pl --action reprocess --mafftDirectory /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT

./globalize_windowbams.pl --fastadir /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT/ --msadir /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT/ --contigs /data/projects/phillippy/projects/hackathon/intermediate_files/postGlobalAlignment_readLengths --output /data/projects/phillippy/projects/hackathon/intermediate_files/combined.sam

# this step needs SamTools >= 1.4

/data/projects/phillippy/software/samtools-1.4/samtools view -h -t /data/projects/phillippy/projects/hackathon/Graph_Genomes_CSHL/config/GRCh38.headerfile.txt /data/projects/phillippy/projects/hackathon/intermediate_files/combined.sam > /data/projects/phillippy/projects/hackathon/intermediate_files/combined_with_header.sam

/data/projects/phillippy/software/samtools-develop/samtools sort /data/projects/phillippy/projects/hackathon/intermediate_files/combined_with_header.sam -o /data/projects/phillippy/projects/hackathon/intermediate_files/combined_with_header_sorted.sam

cat /data/projects/phillippy/projects/hackathon/intermediate_files/combined_with_header_sorted.sam | /data/projects/phillippy/software/samtools-1.4/samtools view -C -T /data/projects/phillippy/projects/hackathon/shared/reference/GRCh38_full_plus_hs38d1_analysis_set_minus_alts.fa - >  /data/projects/phillippy/projects/hackathon/intermediate_files/combined.cram

# do we need both commands?

./checkFinalCRAM.pl --MAFFTdir /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT/ --contigLengths /data/projects/phillippy/projects/hackathon/intermediate_files/postGlobalAlignment_readLengths --preMAFFTBAM /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT.bam --finalOutputCRAM /data/projects/phillippy/projects/hackathon/intermediate_files/combined.cram

./checkMAFFT_input_and_output.pl --MAFFTdir /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT/ --contigLengths /data/projects/phillippy/projects/hackathon/intermediate_files/postGlobalAlignment_readLengths --preMAFFTBAM /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT.bam --finalOutputBAM /data/projects/phillippy/projects/hackathon/intermediate_files/combined_sorted.cram

# Call CRAM2VCF

./CRAM2VCF.pl --CRAM /data/projects/phillippy/projects/hackathon/intermediate_files/combined.cram --referenceFasta /data/projects/phillippy/projects/hackathon/shared/reference/GRCh38_full_plus_hs38d1_analysis_set_minus_alts.fa --output VCF/uber_vcf.vcf --contigLengths /data/projects/phillippy/projects/hackathon/intermediate_files/postGlobalAlignment_readLengths



# v2

./FIND_GLOBAL_ALIGNMENTS_2.pl --alignmentsFile /data/projects/phillippy/projects/hackathon/intermediate_files/AartiInput.sortedWithHeader --referenceFasta /data/projects/phillippy/projects/hackathon/shared/reference/GRCh38_full_plus_hs38d1_analysis_set_minus_alts.fa --outputFile /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT_2.bam --outputTruncatedReads /data/projects/phillippy/projects/hackathon/intermediate_files/truncatedReads_2 --outputReadLengths /data/projects/phillippy/projects/hackathon/intermediate_files/postGlobalAlignment_readLengths_2

./countExpectedGlobalAlignments.pl --BAM /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT_2.bam

./BAM2MAFFT.pl --BAM /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT_2.bam --referenceFasta /data/projects/phillippy/projects/hackathon/shared/reference/GRCh38_full_plus_hs38d1_analysis_set_minus_alts.fa --readsFasta /data/projects/phillippy/projects/hackathon/shared/contigs/AllContigs.fa --outputDirectory /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT_2 --inputTruncatedReads /data/projects/phillippy/projects/hackathon/intermediate_files/truncatedReads_2 

./CALLMAFFT.pl --action kickOff --mafftDirectory /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT_2 --qsub 1

./CALLMAFFT.pl --action check --mafftDirectory /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT_2

./globalize_windowbams.pl --fastadir /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT_2/ --msadir /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT_2/ --contigs /data/projects/phillippy/projects/hackathon/intermediate_files/postGlobalAlignment_readLengths_2 --output /data/projects/phillippy/projects/hackathon/intermediate_files/combined_2.sam;\



./validate_BAM_MSA.pl --BAM /data/projects/phillippy/projects/hackathon/intermediate_files/combined_sorted.bam --referenceFasta /data/projects/phillippy/projects/hackathon/shared/reference/GRCh38_full_plus_hs38d1_analysis_set_minus_alts.fa


./BAM2VCF.pl --BAM /data/projects/phillippy/projects/hackathon/intermediate_files/combined_sorted.bam --referenceFasta /data/projects/phillippy/projects/hackathon/shared/reference/GRCh38_full_plus_hs38d1_analysis_set_minus_alts.fa --output VCF/uber_vcf.vcf

# get CRAM, via SAM sort?

/data/projects/phillippy/software/samtools-1.7/samtools view -h -t /data/projects/phillippy/projects/hackathon/Graph_Genomes_CSHL/config/GRCh38.headerfile.txt /data/projects/phillippy/projects/hackathon/intermediate_files/combined_2.sam > /data/projects/phillippy/projects/hackathon/intermediate_files/combined_2_with_header.sam;\
/data/projects/phillippy/software/samtools-1.7/samtools sort /data/projects/phillippy/projects/hackathon/intermediate_files/combined_2_with_header.sam -o /data/projects/phillippy/projects/hackathon/intermediate_files/combined_2_with_header_sorted.sam

cat /data/projects/phillippy/projects/hackathon/intermediate_files/combined_2_with_header_sorted.sam | /data/projects/phillippy/software/samtools-1.7/samtools view -C -T /data/projects/phillippy/projects/hackathon/shared/reference/GRCh38_full_plus_hs38d1_analysis_set_minus_alts.fa - >  /data/projects/phillippy/projects/hackathon/intermediate_files/combined_2.cram

/data/projects/phillippy/software/samtools-1.7/samtools index /data/projects/phillippy/projects/hackathon/intermediate_files/combined_2.cram

./checkMAFFT_input_and_output.pl --MAFFTdir /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT_2/ --contigLengths /data/projects/phillippy/projects/hackathon/intermediate_files/postGlobalAlignment_readLengths_2 --preMAFFTBAM /data/projects/phillippy/projects/hackathon/intermediate_files/forMAFFT_2.bam --finalOutputCRAM /data/projects/phillippy/projects/hackathon/intermediate_files/combined_2.cram &> output_checkMAFFT_v2

./CRAM2VCF.pl --CRAM /data/projects/phillippy/projects/hackathon/intermediate_files/combined_2.cram --referenceFasta /data/projects/phillippy/projects/hackathon/shared/reference/GRCh38_full_plus_hs38d1_analysis_set_minus_alts.fa --output VCF/graph_v2.vcf --contigLengths /data/projects/phillippy/projects/hackathon/intermediate_files/postGlobalAlignment_readLengths_2

perl CRAM2VCF_checkVariantDistribution.pl --output VCF/graph_v2.vcf

./launch_CRAM2VCF_C++.pl --output VCF/graph_v2.vcf

./CRAM2VCF_createFinalVCF.pl --CRAM /data/projects/phillippy/projects/hackathon/intermediate_files/combined_2.cram --referenceFasta /data/projects/phillippy/projects/hackathon/shared/reference/GRCh38_full_plus_hs38d1_analysis_set_minus_alts.fa --output VCF/graph_v2.vcf

# Chromosome 21 sanity checkFinalCRAM

perl graphStatistics.pl --VCF VCF/graph_v2.vcf --referenceFasta /data/projects/phillippy/projects/hackathon/shared/reference/GRCh38_full_plus_hs38d1_analysis_set_minus_alts.fa
perl minimumSNPSet_check.pl

Rscript graphStatistics_plot.R VCF/graph_v2.vcf

